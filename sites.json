const fetch = require('node-fetch');

exports.handler = async (event) => {
    if (event.httpMethod !== 'POST') {
        return {
            statusCode: 405,
            body: 'Method Not Allowed',
        };
    }

    const { url } = JSON.parse(event.body);

    // GitHub API token (stored securely in environment variables)
    const GITHUB_TOKEN = process.env.GITHUB_TOKEN;

    // GitHub repository details
    const owner = 'alexs771';
    const repo = 'add-your-site';
    const path = 'sites.json';

    // Fetch the existing `sites.json`
    const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
        headers: {
            Authorization: `token ${GITHUB_TOKEN}`,
        },
    });

    const data = await response.json();
    const content = JSON.parse(Buffer.from(data.content, 'base64').toString('utf-8'));

    // Add the new site
    content.push(url);

    // Update the `sites.json` file
    const updatedContent = Buffer.from(JSON.stringify(content, null, 2)).toString('base64');
    await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
        method: 'PUT',
        headers: {
            Authorization: `token ${GITHUB_TOKEN}`,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: 'Added new site',
            content: updatedContent,
            sha: data.sha,
        }),
    });

    return {
        statusCode: 200,
        body: 'Site added successfully',
    };
};
